# ============================================================
# ğŸ‹ï¸ í—¬ìŠ¤ì¼€ì–´ AI ì½˜í…ì¸  ì œì‘ ì•± (Streamlit + GPT-5 Mini í†µí•©)
# ============================================================

import os
import streamlit as st
from dotenv import load_dotenv
from openai import OpenAI

# ============================================================
# ğŸŒ í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ ë° OpenAI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
# ============================================================

load_dotenv()
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")

if OPENAI_API_KEY:
    try:
        client = OpenAI(api_key=OPENAI_API_KEY)
        model_name = "gpt-5-mini"  # GPT-5 Mini ëª¨ë¸ ì‚¬ìš©
    except Exception as e:
        st.error(f"OpenAI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì˜¤ë¥˜: {e}")
        client = None
        model_name = ""
else:
    st.warning("âš ï¸ OPENAI_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. .env íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”.")
    client = None
    model_name = ""

# ============================================================
# ğŸ–¥ Streamlit í˜ì´ì§€ ì„¤ì •
# ============================================================

st.set_page_config(page_title="ğŸ’ª í—¬ìŠ¤ì¼€ì–´ AI ì½˜í…ì¸  ì œì‘", layout="wide")
st.sidebar.title("ë©”ë‰´")
menu = st.sidebar.radio(
    "í˜ì´ì§€ ì„ íƒ",
    ["ğŸ“ í™ë³´ ë¬¸êµ¬+í•´ì‹œíƒœê·¸ í†µí•© ìƒì„±", "ğŸ–¼ ì´ë¯¸ì§€ ìƒì„±(ì¤€ë¹„ ì¤‘)"],
)

# ============================================================
# ğŸ§© ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
# ============================================================

def validate_inputs(service_name, features):
    if not service_name or not features:
        st.warning("âš ï¸ ì„œë¹„ìŠ¤ ì´ë¦„ê³¼ í•µì‹¬ íŠ¹ì§•ì€ ë°˜ë“œì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        return False
    return True

def generate_caption_and_hashtags(client, model, tone, info, hashtag_count=15):
    """
    í•œ ë²ˆì˜ API í˜¸ì¶œë¡œ ì¸ìŠ¤íƒ€ê·¸ë¨ í™ë³´ ë¬¸êµ¬ 3ê°œì™€ í•´ì‹œíƒœê·¸ë¥¼ ë™ì‹œì— ìƒì„±
    """
    prompt = f"""
ë‹¹ì‹ ì€ í—¬ìŠ¤ì¼€ì–´ ì†Œìƒê³µì¸ì„ ìœ„í•œ ì „ë¬¸ ì¸ìŠ¤íƒ€ê·¸ë¨ ì½˜í…ì¸  í¬ë¦¬ì—ì´í„°ì…ë‹ˆë‹¤.

ìš”ì²­:
1. ì•„ë˜ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì¸ìŠ¤íƒ€ê·¸ë¨ ê²Œì‹œë¬¼ì— ìµœì í™”ëœ í™ë³´ ë¬¸êµ¬ 3ê°œë¥¼ ì‘ì„±
   - ê° ë¬¸êµ¬ëŠ” ì²« ì¤„ í›„í‚¹ â†’ í•µì‹¬ ë©”ì‹œì§€ â†’ ëª…í™•í•œ CTA êµ¬ì¡°
   - ì´ëª¨í‹°ì½˜ì„ ì ì ˆíˆ ì‚¬ìš©
   - ë¬¸ì²´ ìŠ¤íƒ€ì¼: {tone}
2. ìœ„ ë¬¸êµ¬ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•´ì‹œíƒœê·¸ {hashtag_count}ê°œë¥¼ ì¶”ì²œ
   - ëŒ€í˜• íƒœê·¸ + ì¤‘í˜• íƒœê·¸ + ì§€ì—­/í‹ˆìƒˆ íƒœê·¸ ê· í˜•
   - ëª¨ë“  íƒœê·¸ëŠ” #íƒœê·¸ í˜•ì‹, ê³µë°± ì—†ì´, ì¤‘ë³µ ì œê±°

[ì •ë³´]
ì„œë¹„ìŠ¤ ì¢…ë¥˜: {info['service_type']}
ì„œë¹„ìŠ¤ëª…: {info['service_name']}
í•µì‹¬ íŠ¹ì§•: {info['features']}
ì§€ì—­: {info['location']}
ì´ë²¤íŠ¸: {info['event_info']}

ì¶œë ¥ í˜•ì‹:
ë¬¸êµ¬:
1. [ë¬¸êµ¬1]
2. [ë¬¸êµ¬2]
3. [ë¬¸êµ¬3]

í•´ì‹œíƒœê·¸:
#[íƒœê·¸1] #[íƒœê·¸2] ... #[íƒœê·¸N]
"""
    response = client.responses.create(
        model=model,
        input=prompt,
        reasoning={"effort": "minimal"}
    )
    return response.output_text.strip()

# ============================================================
# ğŸ“£ í˜ì´ì§€ 1: í™ë³´ ë¬¸êµ¬ + í•´ì‹œíƒœê·¸ í†µí•© ìƒì„±
# ============================================================

if menu == "ğŸ“ í™ë³´ ë¬¸êµ¬+í•´ì‹œíƒœê·¸ í†µí•© ìƒì„±":
    st.title("ğŸ“ ì¸ìŠ¤íƒ€ê·¸ë¨ ë§ì¶¤ í™ë³´ ë¬¸êµ¬ & í•´ì‹œíƒœê·¸ í†µí•© ìƒì„±")
    st.markdown("í—¬ìŠ¤ì¼€ì–´ ì†Œìƒê³µì¸ì„ ìœ„í•œ ìë™ ì½˜í…ì¸  ìƒì„± ë„ìš°ë¯¸ ğŸ’ª")
    st.divider()

    # ì…ë ¥ ì˜ì—­
    st.subheader("ğŸ’¡ ì„œë¹„ìŠ¤ ì •ë³´ ì…ë ¥")
    col1, col2 = st.columns(2)
    with col1:
        service_type = st.selectbox(
            "ì„œë¹„ìŠ¤ ì¢…ë¥˜", 
            ["í—¬ìŠ¤ì¥", "PT (ê°œì¸ íŠ¸ë ˆì´ë‹)", "ìš”ê°€/í•„ë¼í…ŒìŠ¤", "ê±´ê°• ì‹í’ˆ/ë³´ì¡°ì œ", "ê¸°íƒ€"]
        )
    with col2:
        location = st.text_input("ì§€ì—­ (ì˜ˆ: ê°•ë‚¨, ë§ˆí¬êµ¬, ì˜¨ë¼ì¸)")

    service_name = st.text_input("ì œí’ˆ/í´ë˜ìŠ¤ ì´ë¦„")
    features = st.text_area(
        "í•µì‹¬ íŠ¹ì§• ë° ì¥ì  (ì¤„ë°”ê¿ˆ ë˜ëŠ” ì½¤ë§ˆë¡œ êµ¬ë¶„)",
        height=100,
        placeholder="ì˜ˆ: ìµœì‹  ë¨¸ì‹  ì™„ë¹„, 1:1 ë§ì¶¤ ì‹ë‹¨ ê´€ë¦¬, 20ë…„ ê²½ë ¥ íŠ¸ë ˆì´ë„ˆ"
    )

    col3, col4 = st.columns(2)
    with col3:
        event_info = st.text_input("ì´ë²¤íŠ¸/í• ì¸ ë‚´ìš©", placeholder="ì˜ˆ: ì„ ì°©ìˆœ 10ëª… 30% í• ì¸")
    with col4:
        tone = st.selectbox(
            "í†¤ ì„ íƒ",
            ["ì¹œê·¼í•˜ê³  ë™ê¸°ë¶€ì—¬", "ì „ë¬¸ì ì´ê³  ì‹ ë¢°ê°", "ì¬ë¯¸ìˆê³  íŠ¸ë Œë””", "ì°¨ë¶„í•˜ê³  ê°ì„±ì "]
        )

    # í†¤ ì˜ˆì‹œ
    tone_examples = {
        "ì¹œê·¼í•˜ê³  ë™ê¸°ë¶€ì—¬": "ğŸ”¥ ì˜¤ëŠ˜ë¶€í„° ì§„ì§œ ëª¸ ë§Œë“¤ê¸° ì‹œì‘!",
        "ì „ë¬¸ì ì´ê³  ì‹ ë¢°ê°": "ì²´ê³„ì ì¸ ë¶„ì„ê³¼ ê³¼í•™ì  ìš´ë™ë²•ìœ¼ë¡œ ëª¸ì„ ì„¤ê³„í•©ë‹ˆë‹¤.",
        "ì¬ë¯¸ìˆê³  íŠ¸ë Œë””": "ìš´ë™ì€ ì§€ë£¨í•˜ë‹¤ëŠ” í¸ê²¬? ìš°ë¦¬ë‘ í•˜ë©´ NO!",
        "ì°¨ë¶„í•˜ê³  ê°ì„±ì ": "ëª¸ê³¼ ë§ˆìŒì´ í•¨ê»˜ íšŒë³µë˜ëŠ” ì‹œê°„."
    }
    st.caption(f"ğŸ’¬ í†¤ ì˜ˆì‹œ: {tone_examples[tone]}")
    st.divider()

    # í†µí•© ìƒì„± ë²„íŠ¼
    if client:
        if st.button("âœ¨ ë¬¸êµ¬+í•´ì‹œíƒœê·¸ ìƒì„±", type="primary"):
            if validate_inputs(service_name, features):
                with st.spinner("ë¬¸êµ¬ì™€ í•´ì‹œíƒœê·¸ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤..."):
                    info = {
                        "service_type": service_type,
                        "service_name": service_name,
                        "features": features,
                        "location": location if location else "ì „êµ­/ì˜¨ë¼ì¸",
                        "event_info": event_info if event_info else "ì—†ìŒ"
                    }
                    output = generate_caption_and_hashtags(client, model_name, tone, info, hashtag_count=15)

                    # ê²°ê³¼ ì¶œë ¥
                    st.success("âœ… ë¬¸êµ¬ ë° í•´ì‹œíƒœê·¸ ìƒì„± ì™„ë£Œ!")
                    if "ë¬¸êµ¬:" in output and "í•´ì‹œíƒœê·¸:" in output:
                        captions, hashtags = output.split("í•´ì‹œíƒœê·¸:")
                        st.markdown("### ğŸ’¬ ë¬¸êµ¬")
                        for line in captions.split("\n"):
                            if line.strip() and line[0].isdigit():
                                st.markdown(f"- {line.strip()}")
                        st.markdown("### ğŸ”– í•´ì‹œíƒœê·¸")
                        st.code(hashtags.strip(), language="text")
                    else:
                        st.warning("ìƒì„±ëœ ê²°ê³¼ í˜•ì‹ì´ ì˜ˆìƒê³¼ ë‹¤ë¦…ë‹ˆë‹¤. ì¶œë ¥:")
                        st.text(output)
    else:
        st.error("âŒ API í´ë¼ì´ì–¸íŠ¸ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•„ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

# ============================================================
# ğŸ–¼ í˜ì´ì§€ 2: ì´ë¯¸ì§€ ìƒì„± (ê°€ì œ)
# ============================================================

elif menu == "ğŸ–¼ ì´ë¯¸ì§€ ìƒì„±(ì¤€ë¹„ ì¤‘)":
    st.title("ğŸ–¼ ì¸ìŠ¤íƒ€ê·¸ë¨ ì´ë¯¸ì§€/ë°°ë„ˆ ìƒì„± (ì¤€ë¹„ ì¤‘)")
    st.markdown("---")
    st.info(
        "ì´ í˜ì´ì§€ëŠ” í–¥í›„ DALL-E ë˜ëŠ” ì™¸ë¶€ ë””ìì¸ APIë¥¼ í™œìš©í•˜ì—¬ ì‹œê° ìë£Œë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•˜ë„ë¡ í™•ì¥ë  ì˜ˆì •ì…ë‹ˆë‹¤."
    )
    st.subheader("ì˜ˆìƒ ê¸°ëŠ¥ êµ¬ì„±")
    st.markdown("""
    * **í…œí”Œë¦¿ ê¸°ë°˜ ë°°ë„ˆ ìë™ ìƒì„±**: ì†Œìƒê³µì¸ì´ ì—…ë¡œë“œí•œ ì‚¬ì§„ê³¼ í…ìŠ¤íŠ¸ë¥¼ ì¸ìŠ¤íƒ€ê·¸ë¨ ì‚¬ì´ì¦ˆ í…œí”Œë¦¿ì— ìë™ ì ìš©
    * **í…ìŠ¤íŠ¸ â†’ ì´ë¯¸ì§€ ë³€í™˜**: ì…ë ¥ëœ ë¬¸êµ¬ë¥¼ ì‹œê°í™”í•˜ëŠ” ì¸í¬ê·¸ë˜í”½/ì•„ì´ì½˜ ì´ë¯¸ì§€ ìƒì„±
    * **ë©”ë‰´íŒ/ê°€ê²©í‘œ ë””ìì¸**: ì…ë ¥ëœ ê°€ê²© ì •ë³´ë¡œ ê¹”ë”í•˜ê³  ì „ë¬¸ì ì¸ ë””ìì¸ì˜ ê°€ê²©í‘œ ìƒì„±
    """)